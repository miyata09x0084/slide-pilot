"""Slidevãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«ï¼ˆLangChain Toolï¼‰

ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸSlidevã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ç”Ÿæˆã—ã€PDFå‡ºåŠ›ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã€‚
ReActã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‹ã‚‰å‘¼ã³å‡ºã—ã¦Slidevå‹•ä½œç¢ºèªã‚’è¡Œã†ã€‚

Phase 0ï¼ˆMVPæ¤œè¨¼ç”¨ï¼‰:
- ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³
- slidev export ã‚³ãƒãƒ³ãƒ‰ã§PDFç”Ÿæˆ
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¸ã®ãƒ‘ã‚¹è¿”å´ãƒ†ã‚¹ãƒˆ
"""

from langchain_core.tools import tool
from typing import Optional
import json
from pathlib import Path
import subprocess
import shutil
import re

# æ—¢å­˜ã®marp_agentã‹ã‚‰ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import sys
sys.path.insert(0, str(Path(__file__).parent.parent))

from marp_agent import _slugify_en


@tool
def generate_slidev_test(topic: str = "AIæœ€æ–°æƒ…å ±") -> str:
    """Slidevã§ãƒ†ã‚¹ãƒˆã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ç”Ÿæˆï¼ˆãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ç‰ˆï¼‰

    ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸSlidevãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‹ã‚‰PDFã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ç”Ÿæˆã€‚
    MVPã¨ã—ã¦Slidevå‹•ä½œç¢ºèªã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰çµ±åˆãƒ†ã‚¹ãƒˆã«ä½¿ç”¨ã€‚

    å‡¦ç†ãƒ•ãƒ­ãƒ¼:
    1. ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸSlidevãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚’ç”Ÿæˆ
    2. .mdãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜
    3. slidev export ã‚³ãƒãƒ³ãƒ‰ã§PDFå‡ºåŠ›
    4. ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’JSONå½¢å¼ã§è¿”å´

    Args:
        topic: ã‚¹ãƒ©ã‚¤ãƒ‰ã®ãƒˆãƒ”ãƒƒã‚¯ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: "AIæœ€æ–°æƒ…å ±"ï¼‰

    Returns:
        str: ç”Ÿæˆã•ã‚ŒãŸã‚¹ãƒ©ã‚¤ãƒ‰ã®ãƒ‘ã‚¹ã¨çµæœæƒ…å ±ï¼ˆJSONå½¢å¼ï¼‰
    """

    # ãƒ¢ãƒ€ãƒ³ãªãƒ‡ã‚¶ã‚¤ãƒ³ã®Slidevãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ï¼ˆæ‹¡å¼µç‰ˆï¼‰
    slide_content = f"""---
theme: apple-basic
highlighter: shiki
class: text-center
drawings:
  persist: false
fonts:
  sans: 'Inter'
  serif: 'Roboto Slab'
  mono: 'Fira Code'
---

# ğŸš€ {topic}
## 2025å¹´10æœˆç‰ˆ

<div class="pt-12">
  <span class="px-2 py-1 rounded" style="background: #007bff; color: white;">
    AI Industry Report
  </span>
</div>

---
layout: intro
class: text-left
---

## ğŸ“‹ Agenda

<v-clicks>

- ğŸ¢ **Microsoft AI** - ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºAIã®æœ€å‰ç·š
- ğŸ¤– **OpenAI** - GPT-4 Turboã®é€²åŒ–
- ğŸŒŸ **Google Gemini** - ãƒãƒ«ãƒãƒ¢ãƒ¼ãƒ€ãƒ«AIã®å¯èƒ½æ€§
- ğŸ’¡ **ã¾ã¨ã‚** - ä»Šå¾Œã®å±•æœ›

</v-clicks>

---
layout: two-cols
class: px-2
---

## ğŸ¢ Microsoft AI

<v-clicks>

- **Azure OpenAI Service**
  - GPT-4 Turbo å¯¾å¿œ
  - ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºã‚°ãƒ¬ãƒ¼ãƒ‰

- **Copilot Studio**
  - ãƒãƒ¼ã‚³ãƒ¼ãƒ‰AIé–‹ç™º
  - ãƒ“ã‚¸ãƒã‚¹ãƒ—ãƒ­ã‚»ã‚¹çµ±åˆ

- **Semantic Kernel**
  - ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–‹ç™º
  - ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ 

</v-clicks>

::right::

<div class="flex items-center justify-center h-full">
  <div style="width: 300px; height: 200px; background: linear-gradient(135deg, #0078d4 0%, #00bcf2 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: bold; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
    Azure AI
  </div>
</div>

---
layout: two-cols
---

## ğŸ¤– OpenAI æœ€æ–°æƒ…å ±

::left::

### GPT-4 Turbo

<v-clicks>

- âœ… ã‚³ã‚¹ãƒˆå‰Šæ¸›ï¼ˆå‰ä¸–ä»£æ¯”50%ï¼‰
- âœ… 128K context window
- âœ… JSON modeå¯¾å¿œ
- âœ… 2023å¹´12æœˆã¾ã§ã®çŸ¥è­˜

</v-clicks>

::right::

### DALL-E 3

<v-clicks>

- ğŸ¨ ã‚ˆã‚Šé«˜ç²¾åº¦ãªç”»åƒç”Ÿæˆ
- ğŸ§  ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç†è§£å‘ä¸Š
- ğŸ”’ å®‰å…¨æ€§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¼·åŒ–
- ğŸŒ å•†ç”¨åˆ©ç”¨å¯èƒ½

</v-clicks>

---
layout: center
class: text-center
---

## ğŸŒŸ Google Gemini

<div class="grid grid-cols-3 gap-4 mt-8">

<div style="padding: 1rem; background: #e3f2fd; border-radius: 12px;">
  <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">ğŸ§ </div>
  <div style="font-weight: bold;">Gemini Pro</div>
  <div style="font-size: 0.875rem;">ãƒãƒ«ãƒãƒ¢ãƒ¼ãƒ€ãƒ«AI</div>
</div>

<div style="padding: 1rem; background: #e8f5e9; border-radius: 12px;">
  <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">â˜ï¸</div>
  <div style="font-weight: bold;">Vertex AIçµ±åˆ</div>
  <div style="font-size: 0.875rem;">ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºå‘ã‘</div>
</div>

<div style="padding: 1rem; background: #f3e5f5; border-radius: 12px;">
  <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">ğŸ¤</div>
  <div style="font-weight: bold;">Duet AI</div>
  <div style="font-size: 0.875rem;">Workspaceé€£æº</div>
</div>

</div>

---
layout: end
class: text-center
---

# âœ¨ ã¾ã¨ã‚

<div class="mt-8">

## AIæŠ€è¡“ã¯æ€¥é€Ÿã«é€²åŒ–ä¸­ ğŸš€

å„ç¤¾ã®æœ€æ–°æƒ…å ±ã‚’ã‚­ãƒ£ãƒƒãƒã‚¢ãƒƒãƒ—ã—ã¾ã—ã‚‡ã†

</div>

<div style="position: absolute; bottom: 1.5rem; right: 1.5rem; font-size: 0.875rem; opacity: 0.5;">
  Generated by SlidePilot AI
</div>

"""

    try:
        # ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
        slide_dir = Path(__file__).parent.parent / "slides"
        slide_dir.mkdir(parents=True, exist_ok=True)

        # ãƒ•ã‚¡ã‚¤ãƒ«åç”Ÿæˆ
        slug = _slugify_en(topic) or "test"
        md_path = slide_dir / f"{slug}_slidev_test.md"
        md_path.write_text(slide_content, encoding="utf-8")

        # Slidev PDFå‡ºåŠ›
        pdf_path = slide_dir / f"{slug}_slidev_test.pdf"

        slidev = shutil.which("slidev")
        if slidev:
            try:
                # Slidev export ã‚³ãƒãƒ³ãƒ‰
                subprocess.run(
                    ["slidev", "export", str(md_path),
                     "--output", str(pdf_path),
                     "--format", "pdf",
                     "--timeout", "60000"],  # 60ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
                    check=True,
                    stdout=subprocess.PIPE,
                    stderr=subprocess.PIPE,
                    timeout=90  # ãƒ—ãƒ­ã‚»ã‚¹å…¨ä½“ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
                )

                # çµ¶å¯¾ãƒ‘ã‚¹ã‹ã‚‰ç›¸å¯¾ãƒ‘ã‚¹ã«å¤‰æ›ï¼ˆfrontend/publicã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ã™ã‚‹ï¼‰
                relative_path = str(pdf_path.relative_to(slide_dir.parent))

                return json.dumps({
                    "status": "success",
                    "message": f"âœ… Slidevã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ç”Ÿæˆã—ã¾ã—ãŸ: {pdf_path.name}",
                    "title": topic,
                    "slide_path": relative_path
                }, ensure_ascii=False)

            except subprocess.TimeoutExpired:
                relative_path = str(md_path.relative_to(slide_dir.parent))
                return json.dumps({
                    "status": "error",
                    "message": "âš ï¸ PDFç”ŸæˆãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸï¼ˆ90ç§’è¶…éï¼‰",
                    "title": topic,
                    "slide_path": relative_path,
                    "error": "Playwrightåˆå›ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"
                }, ensure_ascii=False)

            except subprocess.CalledProcessError as e:
                # PDFç”Ÿæˆå¤±æ•—æ™‚ã¯MDã®ã¿è¿”ã™
                error_msg = e.stderr.decode() if e.stderr else str(e)
                relative_path = str(md_path.relative_to(slide_dir.parent))
                return json.dumps({
                    "status": "partial",
                    "message": "âš ï¸ PDFç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚Markdownã®ã¿ä¿å­˜ã—ã¾ã—ãŸã€‚",
                    "title": topic,
                    "slide_path": relative_path,
                    "error": f"è©³ç´°: {error_msg}"
                }, ensure_ascii=False)
        else:
            # slidevæœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ™‚
            relative_path = str(md_path.relative_to(slide_dir.parent))
            return json.dumps({
                "status": "md_only",
                "message": "âš ï¸ slidevãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚Markdownã®ã¿ä¿å­˜ã—ã¾ã—ãŸã€‚",
                "title": topic,
                "slide_path": relative_path,
                "error": "slidevã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„: npm install -g slidev"
            }, ensure_ascii=False)

    except Exception as e:
        # äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼
        return json.dumps({
            "status": "error",
            "message": f"âŒ ã‚¹ãƒ©ã‚¤ãƒ‰ç”Ÿæˆä¾‹å¤–: {str(e)}",
            "title": topic
        }, ensure_ascii=False)
