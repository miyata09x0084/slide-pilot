# Cloud Runç›´æ¥æ¥ç¶šã«ã‚ˆã‚‹502ã‚¨ãƒ©ãƒ¼è§£æ±ºç­–

## ğŸ“‹ ç›®æ¬¡

1. [å•é¡Œã®æ¦‚è¦](#å•é¡Œã®æ¦‚è¦)
2. [æ ¹æœ¬åŸå› ](#æ ¹æœ¬åŸå› )
3. [è§£æ±ºç­–ã®è¨­è¨ˆ](#è§£æ±ºç­–ã®è¨­è¨ˆ)
4. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æ](#ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æ)
5. [å®Ÿè£…è¨ˆç”»](#å®Ÿè£…è¨ˆç”»)
6. [ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †](#ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †)
7. [æ¤œè¨¼æ–¹æ³•](#æ¤œè¨¼æ–¹æ³•)

---

## å•é¡Œã®æ¦‚è¦

### ç¾è±¡

**æœ¬ç•ªç’°å¢ƒã®ã¿**ã§ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿï¼š

```
POST https://slide-pilot-474305.web.app/api/agent/threads/.../runs/stream
502 (Bad Gateway)
```

- âœ… **é–‹ç™ºç’°å¢ƒ**: æ­£å¸¸å‹•ä½œ
- âŒ **æœ¬ç•ªç’°å¢ƒ**: 502ã‚¨ãƒ©ãƒ¼
- âœ… **ã‚¹ãƒ©ã‚¤ãƒ‰è‡ªä½“**: æ­£å¸¸ã«ç”Ÿæˆã•ã‚Œã¦ã„ã‚‹ï¼ˆLangSmithç¢ºèªæ¸ˆã¿ï¼‰
- âŒ **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**: ã‚¹ãƒˆãƒªãƒ¼ãƒ åˆ‡æ–­ã§ã‚¨ãƒ©ãƒ¼è¡¨ç¤º

### å½±éŸ¿

- ã‚¹ãƒ©ã‚¤ãƒ‰ç”Ÿæˆã¯å®Œäº†ã™ã‚‹ãŒã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã€Œã‚¨ãƒ©ãƒ¼ã€ã¨è¡¨ç¤ºã•ã‚Œã‚‹
- è‡ªå‹•ç”»é¢é·ç§»ãŒå®Ÿè¡Œã•ã‚Œãªã„ï¼ˆUXæ‚ªåŒ–ï¼‰
- ç”Ÿæˆã•ã‚ŒãŸã‚¹ãƒ©ã‚¤ãƒ‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ï¼ˆæ‰‹å‹•ã§ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹å¿…è¦ï¼‰

---

## æ ¹æœ¬åŸå› 

### ç’°å¢ƒå·®åˆ†ã®åˆ†æ

#### é–‹ç™ºç’°å¢ƒã®æ¥ç¶šçµŒè·¯

```
Frontend (localhost:5173)
    â†“ fetch('/api/agent/...')
Vite Proxy
    â†“
FastAPI (localhost:8001)
    â†“ httpx.stream()
LangGraph (localhost:2024)
    â†“ 113ç§’ã§å®Œäº†
âœ… æˆåŠŸï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãªã—ï¼‰
```

#### æœ¬ç•ªç’°å¢ƒã®æ¥ç¶šçµŒè·¯ï¼ˆç¾çŠ¶ï¼‰

```
Frontend (Firebase Hosting)
    â†“ fetch('/api/agent/...')
Firebase Hosting Rewrite Rule
    â†“ ï¼ˆã“ã“ã§60ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰âš ï¸
Cloud Run (asia-northeast1)
    â†“ httpx.stream()
LangGraph Cloud (ç±³å›½)
    â†“ 113ç§’ã§å®Œäº†
âŒ å¤±æ•—ï¼ˆFirebase HostingãŒ60ç§’ã§åˆ‡æ–­ï¼‰
```

### ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³

| æ™‚é–“ | ã‚¤ãƒ™ãƒ³ãƒˆ | å ´æ‰€ |
|------|---------|------|
| 0ç§’ | SSEã‚¹ãƒˆãƒªãƒ¼ãƒ é–‹å§‹ | LangGraph Cloud |
| 0-113ç§’ | ã‚¹ãƒ©ã‚¤ãƒ‰ç”Ÿæˆä¸­ï¼ˆSSEã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡ï¼‰ | LangGraph Cloud |
| **60ç§’** | **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ¤œçŸ¥** | **Firebase Hosting** |
| **60ç§’** | **502 Bad Gatewayè¿”å´** | **Firebase Hosting** |
| 113ç§’ | ã‚¹ãƒ©ã‚¤ãƒ‰ç”Ÿæˆå®Œäº† | LangGraph Cloud |
| 113ç§’ | ã‚¹ãƒˆãƒªãƒ¼ãƒ çµ‚äº†ï¼ˆå±Šã‹ãªã„ï¼‰ | LangGraph Cloud |

### æ ¹æœ¬åŸå› ã®ç‰¹å®š

**Firebase Hosting ã® Cloud Run Rewrite ã«ã¯æš—é»™çš„ãª60ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãŒå­˜åœ¨ã™ã‚‹**

- Googleã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¯æ˜è¨˜ã•ã‚Œã¦ã„ãªã„
- å®Ÿæ¸¬å€¤: ç´„60ç§’ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
- Cloud Runè‡ªä½“ã¯600ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã«å¯¾å¿œã—ã¦ã„ã‚‹ãŒã€Firebase Hostingã®åˆ¶é™ã§ç„¡åŠ¹åŒ–ã•ã‚Œã‚‹
- SSEï¼ˆServer-Sent Eventsï¼‰ã®ã‚ˆã†ãªé•·æ™‚é–“æ¥ç¶šã«ã¯ä¸å‘ã

**è¨¼æ‹ **:
- LangGraphã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·: 113ç§’
- Firebase Hostingã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: ç´„60ç§’
- 113ç§’ > 60ç§’ â†’ **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç™ºç”Ÿ**

---

## è§£æ±ºç­–ã®è¨­è¨ˆ

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å¤‰æ›´

#### å¤‰æ›´å‰ï¼ˆç¾çŠ¶ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend   â”‚
â”‚   (CDN)     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ /api/agent/**
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Firebase Hostingâ”‚ â† âš ï¸ 60ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
â”‚  (Rewrite)      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Cloud Run     â”‚ â† 600ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆç„¡åŠ¹ï¼‰
â”‚  (FastAPI)      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LangGraph Cloud â”‚
â”‚   (ç±³å›½)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å¤‰æ›´å¾Œï¼ˆææ¡ˆï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend   â”‚
â”‚   (CDN)     â”‚
â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
   â”‚      â”‚
   â”‚      â”‚ /api/agent/** (é•·æ™‚é–“æ¥ç¶š)
   â”‚      â”‚
   â”‚      â†“
   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   â”‚   Cloud Run     â”‚ â† âœ… 600ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæœ‰åŠ¹
   â”‚   â”‚  (FastAPI)      â”‚
   â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚          â”‚
   â”‚          â†“
   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   â”‚ LangGraph Cloud â”‚
   â”‚   â”‚   (ç±³å›½)        â”‚
   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â”‚ /api/upload-pdf, /api/slides/** (çŸ­æ™‚é–“æ¥ç¶š)
   â”‚
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Firebase Hostingâ”‚ â† 60ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆå•é¡Œãªã—ï¼‰
â”‚  (Rewrite)      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Cloud Run     â”‚
â”‚  (FastAPI)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¥ç¶šå…ˆã®ä½¿ã„åˆ†ã‘

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | æ¥ç¶šå…ˆ | ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ | ç†ç”± |
|---------------|--------|------------|------|
| `/api/agent/**` | Cloud Runç›´æ¥ | 600ç§’ | SSEé•·æ™‚é–“æ¥ç¶šã®ãŸã‚ |
| `/api/upload-pdf` | Firebase HostingçµŒç”± | 60ç§’ | çŸ­æ™‚é–“ã§å®Œäº†ã™ã‚‹ãŸã‚ |
| `/api/slides/{filename}` | Firebase HostingçµŒç”± | 60ç§’ | çŸ­æ™‚é–“ã§å®Œäº†ã™ã‚‹ãŸã‚ |
| `/api/health` | Firebase HostingçµŒç”± | 60ç§’ | çŸ­æ™‚é–“ã§å®Œäº†ã™ã‚‹ãŸã‚ |

### ãƒ¡ãƒªãƒƒãƒˆ

- âœ… Firebase Hostingã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆåˆ¶é™ã‚’å›é¿
- âœ… Cloud Runã®600ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãŒãƒ•ãƒ«æ´»ç”¨å¯èƒ½
- âœ… ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰å¤‰æ›´ãªã—ï¼ˆCORSè¨­å®šã®ã¿ï¼‰
- âœ… é–‹ç™ºç’°å¢ƒã‚‚å¼•ãç¶šãå‹•ä½œï¼ˆç’°å¢ƒå¤‰æ•°ã§åˆ‡ã‚Šæ›¿ãˆï¼‰
- âœ… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šï¼ˆ1ãƒ›ãƒƒãƒ—å‰Šæ¸›ï¼‰

### ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ

- âš ï¸ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãŒ2ã¤ã®URLã«æ¥ç¶šã™ã‚‹è¤‡é›‘ã•
- âš ï¸ CORSè¨­å®šãŒå¿…è¦
- âš ï¸ Cloud Runã®URLãŒå…¬é–‹ã•ã‚Œã‚‹ï¼ˆãŸã ã—æ—¢ã«å…¬é–‹æ¸ˆã¿ï¼‰

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æ

### ç¾çŠ¶ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ…‹

#### Cloud Runã®å…¬é–‹ãƒ¬ãƒ™ãƒ«

```bash
# IAMãƒãƒªã‚·ãƒ¼ç¢ºèª
gcloud run services get-iam-policy slidepilot-api --region=asia-northeast1

# çµæœ
bindings:
  - members:
    - allUsers  # â† èª°ã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
    role: roles/run.invoker
```

**é‡è¦**: Cloud Runã¯æ—¢ã« `--allow-unauthenticated` ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ãŠã‚Šã€**å®Œå…¨ã«å…¬é–‹ã•ã‚Œã¦ã„ã‚‹**

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çµè«–

| é …ç›® | ç¾çŠ¶ï¼ˆFirebaseçµŒç”±ï¼‰ | å¤‰æ›´å¾Œï¼ˆCloud Runç›´æ¥ï¼‰ | å·®åˆ† |
|------|---------------------|----------------------|------|
| èªè¨¼ | ãªã— | ãªã— | å¤‰åŒ–ãªã— |
| ãƒ¬ãƒ¼ãƒˆåˆ¶é™ | ãªã— | ãªã— | å¤‰åŒ–ãªã— |
| URLã®å…¬é–‹åº¦ | å…¬é–‹ | å…¬é–‹ | å¤‰åŒ–ãªã— |
| ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ç¯„å›² | èª°ã§ã‚‚ | èª°ã§ã‚‚ | å¤‰åŒ–ãªã— |
| CORSä¿è­· | ã‚ã‚Š | ã‚ã‚Š | å¤‰åŒ–ãªã— |

**çµè«–**: **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®æ–°ã—ã„ãƒªã‚¹ã‚¯ã¯ç™ºç”Ÿã—ãªã„**

---

## å®Ÿè£…è¨ˆç”»

### å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

| ãƒ•ã‚¡ã‚¤ãƒ« | å¤‰æ›´å†…å®¹ |
|---------|---------|
| `backend/app/config.py` | CORSè¨­å®šã«æœ¬ç•ªURLè¿½åŠ ï¼ˆ+2è¡Œï¼‰ |
| `frontend/src/features/generation/hooks/useReactAgent.ts` | API_BASE_URLã‚’ç’°å¢ƒå¤‰æ•°åŒ–ï¼ˆ1è¡Œä¿®æ­£ï¼‰ |
| `frontend/.env.production` | Cloud Run URLã‚’è¨­å®šï¼ˆæ–°è¦ä½œæˆï¼‰ |

### Phase 1: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ä¿®æ­£

**ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/app/config.py`

```python
# CORSè¨­å®š
CORS_ORIGINS: list = [
    "http://localhost:5173",                      # é–‹ç™ºç’°å¢ƒ
    "http://localhost:3000",                      # ä»£æ›¿ãƒãƒ¼ãƒˆ
    "https://slide-pilot-474305.web.app",         # æœ¬ç•ªç’°å¢ƒ â† è¿½åŠ 
    "https://slide-pilot-474305.firebaseapp.com", # æœ¬ç•ªç’°å¢ƒï¼ˆä»£æ›¿ï¼‰ â† è¿½åŠ 
]
```

### Phase 2: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ä¿®æ­£

**ãƒ•ã‚¡ã‚¤ãƒ«**: `frontend/src/features/generation/hooks/useReactAgent.ts`

```typescript
// å¤‰æ›´å‰
const API_BASE_URL = '/api/agent';

// å¤‰æ›´å¾Œ
const API_BASE_URL = import.meta.env.VITE_LANGGRAPH_PROXY_URL || '/api/agent';
```

**ãƒ•ã‚¡ã‚¤ãƒ«**: `frontend/.env.production`ï¼ˆæ–°è¦ä½œæˆï¼‰

```bash
VITE_LANGGRAPH_PROXY_URL=https://slidepilot-api-692318722679.asia-northeast1.run.app/api/agent
VITE_GOOGLE_CLIENT_ID=<æ—¢å­˜ã®å€¤>
VITE_API_URL=https://slide-pilot-474305.web.app/api
```

---

## ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

### ã‚¹ãƒ†ãƒƒãƒ—1: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
# Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
cd backend
gcloud builds submit --tag asia-northeast1-docker.pkg.dev/slide-pilot-474305/cloud-run-source-deploy/slidepilot-api:latest

# Cloud Runãƒ‡ãƒ—ãƒ­ã‚¤
gcloud run deploy slidepilot-api \
  --image asia-northeast1-docker.pkg.dev/slide-pilot-474305/cloud-run-source-deploy/slidepilot-api:latest \
  --region asia-northeast1 \
  --platform managed \
  --allow-unauthenticated \
  --memory 1Gi \
  --timeout 600 \
  --set-env-vars LANGGRAPH_API_URL=https://slide-pilot-474305.us.langgraph.app
```

### ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
# ãƒ“ãƒ«ãƒ‰
cd frontend
npm run build

# ç’°å¢ƒå¤‰æ•°ç¢ºèª
grep -r "slidepilot-api" dist/assets/*.js

# ãƒ‡ãƒ—ãƒ­ã‚¤
firebase deploy --only hosting
```

---

## æ¤œè¨¼æ–¹æ³•

### æœ¬ç•ªç’°å¢ƒã§ã®ç¢ºèª

```bash
# 1. PDFã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
# 2. Chrome DevTools â†’ Network
# 3. threads/.../runs/stream ã‚’ç¢ºèª

# æœŸå¾…çµæœ:
# URL: https://slidepilot-api-692318722679.asia-northeast1.run.app/api/agent/...
# Status: 200 OK
# Time: ~113ç§’
```

---

## å¤‰æ›´å±¥æ­´

| æ—¥ä»˜ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | å¤‰æ›´å†…å®¹ |
|------|----------|---------|
| 2025-11-10 | 1.0.0 | åˆç‰ˆä½œæˆ |
